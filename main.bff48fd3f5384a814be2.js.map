{"version":3,"file":"main.bff48fd3f5384a814be2.js","mappings":"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","sources":["webpack://sse-ws-chat/./src/frontend/js/websocket.js","webpack://sse-ws-chat/./src/frontend/js/templates.js","webpack://sse-ws-chat/./src/frontend/js/utils/cookies.js","webpack://sse-ws-chat/./src/frontend/js/chat.js","webpack://sse-ws-chat/./src/frontend/index.js"],"sourcesContent":["const RECONNECT = {\n  MAX_ATTEMPTS: 5,\n  BASE_DELAY: 1000,\n  MAX_DELAY: 30000,\n};\n\nexport default class WebSocketClient {\n  constructor() {\n    this.ws = null;\n    this.handlers = new Map();\n    this.reconnectAttempts = 0;\n    this.connected = false;\n    this.authorized = false;\n  }\n\n  getWebSocketUrl() {\n    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n    const host =\n      process.env.NODE_ENV === 'development' ? 'localhost:7070' : 'sse-ws-chat.onrender.com';\n    return `${protocol}//${host}/ws`;\n  }\n\n  async connect() {\n    if (this.ws) {\n      this.close();\n    }\n\n    return new Promise((resolve, reject) => {\n      try {\n        this.ws = new WebSocket(this.getWebSocketUrl());\n\n        const timeout = setTimeout(() => {\n          this.close();\n          reject(new Error('Таймаут подключения'));\n        }, 5000);\n\n        this.ws.onopen = () => {\n          clearTimeout(timeout);\n          this.connected = true;\n          this.bindEvents();\n          resolve(true);\n        };\n\n        this.ws.onerror = (error) => {\n          clearTimeout(timeout);\n          this.connected = false;\n          reject(error);\n        };\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  waitForConnection() {\n    return new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => {\n        this.close();\n        reject(new Error('Таймаут подключения'));\n      }, 5000);\n\n      this.ws.onopen = () => {\n        clearTimeout(timeout);\n        this.connected = true;\n        this.bindEvents();\n        resolve();\n      };\n\n      this.ws.onerror = (error) => {\n        clearTimeout(timeout);\n        this.connected = false;\n        reject(error);\n      };\n    });\n  }\n\n  async handleReconnect() {\n    if (this.reconnectAttempts >= RECONNECT.MAX_ATTEMPTS) {\n      throw new Error('Превышено количество попыток подключения');\n    }\n\n    this.reconnectAttempts++;\n    const delay = Math.min(\n      RECONNECT.BASE_DELAY * Math.pow(2, this.reconnectAttempts),\n      RECONNECT.MAX_DELAY,\n    );\n\n    await new Promise((resolve) => setTimeout(resolve, delay));\n    return this.connect();\n  }\n\n  bindEvents() {\n    if (!this.ws) return;\n\n    this.ws.onmessage = this.handleMessage.bind(this);\n    this.ws.onclose = this.handleClose.bind(this);\n    this.ws.onerror = this.handleError.bind(this);\n  }\n\n  handleMessage(event) {\n    try {\n      const message = JSON.parse(event.data);\n      const handler = this.handlers.get(message.type);\n      if (handler) handler(message);\n    } catch (error) {\n      console.error('Ошибка обработки сообщения:', error);\n    }\n  }\n\n  handleClose(event) {\n    this.connected = false;\n    if (event.code !== 1000) {\n      console.log('WebSocket закрыт с кодом:', event.code);\n      this.reconnect();\n    }\n  }\n\n  handleError(error) {\n    console.error('WebSocket ошибка:', error);\n    this.connected = false;\n  }\n\n  on(type, callback) {\n    if (typeof callback !== 'function') {\n      throw new Error('Callback должен быть функцией');\n    }\n    this.handlers.set(type, callback);\n  }\n\n  send(data) {\n    if (!this.isConnected()) {\n      console.error('Попытка отправки сообщения при неактивном соединении');\n      return;\n    }\n    try {\n      this.ws.send(JSON.stringify(data));\n    } catch (error) {\n      console.error('Ошибка отправки:', error);\n      this.reconnect();\n    }\n  }\n\n  login(nickname, sessionId) {\n    return new Promise((resolve, reject) => {\n      if (!this.isConnected()) {\n        reject(new Error('WebSocket не подключен'));\n        return;\n      }\n\n      const loginHandler = (response) => {\n        if (response.type === 'login') {\n          this.handlers.delete('login');\n          resolve(response);\n        }\n      };\n\n      this.handlers.set('login', loginHandler);\n\n      this.send({\n        type: 'login',\n        nickname,\n        sessionId,\n      });\n    });\n  }\n\n  sendMessage(text) {\n    this.send({\n      type: 'message',\n      text,\n    });\n  }\n\n  async reconnect() {\n    this.close();\n    await this.connect();\n  }\n\n  isConnected() {\n    return this.ws && this.ws.readyState === WebSocket.OPEN && this.connected;\n  }\n\n  close() {\n    if (this.ws) {\n      this.connected = false;\n      try {\n        this.ws.close(1000); // Normal closure\n      } catch (error) {\n        console.error('Ошибка закрытия WebSocket:', error);\n      }\n      this.ws = null;\n    }\n  }\n}\n","export function createMessageElement(from, text, timestamp, isOwn) {\n  const time = new Intl.DateTimeFormat('ru', {\n    hour: '2-digit',\n    minute: '2-digit',\n  }).format(new Date(timestamp));\n\n  return `\n    <div class=\"message ${isOwn ? 'own' : 'other'}\">\n      <div class=\"message-header\">${isOwn ? 'Вы' : escapeHtml(from)}</div>\n      <div class=\"message-text\">${escapeHtml(text)}</div>\n      <div class=\"message-time\">${time}</div>\n    </div>\n  `;\n}\n\nexport function createUserElement(user, isCurrentUser) {\n  return `\n    <li class=\"user ${isCurrentUser ? 'current' : ''}\">\n      ${isCurrentUser ? 'Вы' : escapeHtml(user)}\n    </li>\n  `;\n}\n\nfunction escapeHtml(text) {\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n}\n","export function setCookie(name, value, days = 7) {\n  const date = new Date();\n  date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);\n  const encodedValue = encodeURIComponent(value);\n  document.cookie = `${name}=${encodedValue};expires=${date.toUTCString()};path=/;SameSite=Strict;Secure`;\n}\n\nexport function getCookie(name) {\n  try {\n    const matches = document.cookie.match(\n      new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()[\\]\\\\/+^])/g, '\\\\$1') + '=([^;]*)'),\n    );\n    return matches ? decodeURIComponent(matches[1]) : null;\n  } catch (error) {\n    console.error('Ошибка чтения cookie:', error);\n    return null;\n  }\n}\n\nexport function deleteCookie(name) {\n  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;SameSite=Strict;Secure`;\n}\n\nexport function hasCookie(name) {\n  return getCookie(name) !== null;\n}\n","import WebSocketClient from './websocket.js';\nimport { createMessageElement, createUserElement } from './templates.js';\nimport { setCookie, getCookie, deleteCookie, hasCookie } from './utils/cookies.js';\n\nconst COOKIE_SETTINGS = {\n  nickname: 'nickname',\n  sessionId: 'sessionId',\n};\n\nexport default class Chat {\n  constructor() {\n    this.webSocket = null;\n    this.nickname = getCookie(COOKIE_SETTINGS.nickname);\n    this.sessionId = getCookie(COOKIE_SETTINGS.sessionId) || crypto.randomUUID();\n    this.messagesList = document.getElementById('messages');\n    this.usersList = document.getElementById('usersList');\n    this.messageForm = document.getElementById('messageForm');\n    this.messageInput = document.getElementById('messageInput');\n    this.initialized = false;\n    this.authorized = false;\n  }\n\n  async init() {\n    if (this.initialized) return;\n\n    try {\n      if (!this.nickname || !this.validateNickname(this.nickname).valid) {\n        this.nickname = await this.promptNickname();\n        if (!this.nickname) return;\n\n        setCookie('nickname', this.nickname);\n        setCookie('sessionId', this.sessionId);\n      }\n\n      await this.initWebSocket();\n      this.bindEvents();\n      this.initialized = true;\n    } catch (error) {\n      console.error('Ошибка инициализации:', error);\n      this.cleanup();\n      alert('Ошибка подключения к чату. Попробуйте позже.');\n    }\n  }\n\n  async promptNickname() {\n    while (true) {\n      const nickname = prompt('Введите никнейм (2-20 символов):');\n      if (!nickname) return null;\n\n      const isValid = this.validateNickname(nickname);\n      if (isValid.valid) return nickname;\n\n      alert(isValid.message);\n    }\n  }\n\n  validateNickname(nickname) {\n    if (nickname.length < 2 || nickname.length > 20) {\n      return { valid: false, message: 'Длина никнейма должна быть от 2 до 20 символов' };\n    }\n    if (!/^[a-zA-Z0-9_-]+$/.test(nickname)) {\n      return { valid: false, message: 'Используйте только буквы, цифры, дефис и подчеркивание' };\n    }\n    return { valid: true };\n  }\n\n  async initWebSocket() {\n    try {\n      this.webSocket = new WebSocketClient();\n      await this.webSocket.connect();\n      this.setupWebSocketHandlers();\n\n      const loginResult = await this.webSocket.login(this.nickname, this.sessionId);\n      if (!loginResult.success) {\n        throw new Error(loginResult.message || 'Ошибка авторизации');\n      }\n\n      return true;\n    } catch (error) {\n      console.error('Ошибка подключения:', error);\n      this.cleanup();\n      throw error;\n    }\n  }\n\n  setupWebSocketHandlers() {\n    this.webSocket.on('login', this.handleLogin.bind(this));\n    this.webSocket.on('users', this.updateUserList.bind(this));\n    this.webSocket.on('message', this.addMessage.bind(this));\n    this.webSocket.on('error', this.handleError.bind(this));\n  }\n\n  bindEvents() {\n    this.messageForm.addEventListener('submit', this.handleSubmit.bind(this));\n    window.addEventListener('beforeunload', () => {\n      if (this.webSocket) {\n        this.webSocket.close();\n      }\n    });\n  }\n\n  handleSubmit(event) {\n    event.preventDefault();\n    const text = this.messageInput.value.trim();\n\n    if (!text) return;\n\n    if (this.webSocket && this.webSocket.isConnected()) {\n      this.webSocket.sendMessage(text);\n      this.messageInput.value = '';\n    } else {\n      console.error('Чат не подключен');\n      this.reconnect();\n    }\n  }\n\n  async handleLogin(message) {\n    try {\n      if (!message.success) {\n        console.error('Ошибка авторизации:', message.message);\n        this.authorized = false;\n        this.cleanup();\n        await this.reconnect();\n        return;\n      }\n\n      this.authorized = true;\n      console.log('Успешная авторизация');\n    } catch (error) {\n      console.error('Ошибка обработки авторизации:', error);\n      this.cleanup();\n    }\n  }\n\n  handleError(error) {\n    console.error('Ошибка чата:', error);\n    alert(error.message || 'Произошла ошибка');\n    if (error.type === 'auth') {\n      this.reconnect();\n    }\n  }\n\n  async reconnect() {\n    this.initialized = false;\n    if (this.webSocket) {\n      this.webSocket.close();\n      this.webSocket = null;\n    }\n    await this.initWebSocket();\n    if (this.webSocket && this.webSocket.isConnected()) {\n      this.webSocket.login(this.nickname, this.sessionId);\n    }\n  }\n\n  updateUserList(users) {\n    if (!Array.isArray(users)) return;\n\n    this.usersList.innerHTML = users\n      .map((user) => createUserElement(user, user === this.nickname))\n      .join('');\n  }\n\n  addMessage({ from, text, timestamp }) {\n    if (!from || !text || !timestamp) return;\n\n    const messageHTML = createMessageElement(from, text, timestamp, from === this.nickname);\n    this.messagesList.insertAdjacentHTML('beforeend', messageHTML);\n    this.messagesList.scrollTop = this.messagesList.scrollHeight;\n  }\n\n  cleanup() {\n    try {\n      deleteCookie(COOKIE_SETTINGS.nickname);\n      deleteCookie(COOKIE_SETTINGS.sessionId);\n      this.nickname = null;\n      this.sessionId = crypto.randomUUID();\n      this.initialized = false;\n      this.authorized = false;\n    } catch (error) {\n      console.error('Ошибка очистки состояния:', error);\n    }\n  }\n\n  destroy() {\n    if (this.webSocket) {\n      this.webSocket.close();\n      this.webSocket = null;\n    }\n    this.cleanup();\n    this.initialized = false;\n    this.authorized = false;\n    this.messagesList.innerHTML = '';\n    this.usersList.innerHTML = '';\n  }\n}\n","import './css/style.css';\nimport Chat from './js/chat.js';\n\nclass ChatApp {\n  constructor() {\n    this.chat = null;\n    this.init();\n  }\n\n  async init() {\n    try {\n      if (this.chat) {\n        console.warn('Чат уже инициализирован');\n        return;\n      }\n\n      this.chat = new Chat();\n      await this.chat.init();\n\n      if (process.env.NODE_ENV === 'development') {\n        window.chat = this.chat;\n      }\n\n      this.bindEvents();\n    } catch (error) {\n      console.error('Ошибка инициализации чата:', error);\n      alert('Не удалось подключиться к чату. Попробуйте перезагрузить страницу.');\n    }\n  }\n\n  bindEvents() {\n    window.addEventListener('beforeunload', this.cleanup.bind(this));\n    window.addEventListener('unload', this.cleanup.bind(this));\n  }\n\n  cleanup() {\n    if (this.chat) {\n      this.chat.destroy();\n      this.chat = null;\n    }\n    if (window.chat) {\n      delete window.chat;\n    }\n  }\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  new ChatApp();\n});\n"],"names":["RECONNECT","WebSocketClient","constructor","this","ws","handlers","Map","reconnectAttempts","connected","authorized","getWebSocketUrl","window","location","protocol","connect","close","Promise","resolve","reject","WebSocket","timeout","setTimeout","Error","onopen","clearTimeout","bindEvents","onerror","error","waitForConnection","handleReconnect","delay","Math","min","pow","onmessage","handleMessage","bind","onclose","handleClose","handleError","event","message","JSON","parse","data","handler","get","type","console","code","log","reconnect","on","callback","set","send","isConnected","stringify","login","nickname","sessionId","response","delete","sendMessage","text","readyState","OPEN","escapeHtml","div","document","createElement","textContent","innerHTML","setCookie","name","value","days","date","Date","setTime","getTime","encodedValue","encodeURIComponent","cookie","toUTCString","getCookie","matches","match","RegExp","replace","decodeURIComponent","deleteCookie","COOKIE_SETTINGS","Chat","webSocket","crypto","randomUUID","messagesList","getElementById","usersList","messageForm","messageInput","initialized","init","validateNickname","valid","promptNickname","initWebSocket","cleanup","alert","prompt","isValid","length","test","setupWebSocketHandlers","loginResult","success","handleLogin","updateUserList","addMessage","addEventListener","handleSubmit","preventDefault","trim","users","Array","isArray","map","user","isCurrentUser","createUserElement","join","from","timestamp","messageHTML","isOwn","time","Intl","DateTimeFormat","hour","minute","format","createMessageElement","insertAdjacentHTML","scrollTop","scrollHeight","destroy","ChatApp","chat","warn"],"sourceRoot":""}